---
const {
  src = "",
  ariaLabel = "Audio player",
  filename,
  poster,
} = Astro.props as {
  src?: string;
  ariaLabel?: string;
  filename?: string;
  poster?: string;
};

// Resolve audioSrc server-side
let audioSrc: string = src;
if (!/^https?:\/\//i.test(src) && !src.startsWith("/")) {
  try {
    audioSrc = new URL(`../assets/audio-lessons/${src}`, import.meta.url).href;
  } catch (e) {
    audioSrc = src;
  }
}
const uid = `ap-${Math.random().toString(36).slice(2, 9)}`;
---

<div
  class="audio-player"
  data-audio-filename={filename || ""}
  data-audio-poster={poster || ""}
>
  <audio
    id={`audio-${uid}`}
    controls
    src={audioSrc}
    aria-label={ariaLabel}
    preload="metadata"
    style="width:100%;max-width:560px;"
  >
    <source src={audioSrc} type="audio/mp4" />
    Your browser does not support the audio element.
  </audio>

  <script type="module">
    (function () {
      try {
        const script = document.currentScript;
        const container =
          script && script.closest && script.closest(".audio-player");
        if (!container) return;
        const audio = container.querySelector("audio");
        if (!audio) return;

        const title =
          container.dataset.audioFilename || document.title || "Audio";

        let mediaSessionReady = false;
        let wakeLockSentinel = null;
        let keepAliveTimer = null;
        let lastUpdateTime = 0;

        async function requestWakeLock() {
          try {
            if ("wakeLock" in navigator && !wakeLockSentinel) {
              wakeLockSentinel = await navigator.wakeLock.request("screen");
              console.log("Wake Lock attivato");

              wakeLockSentinel.addEventListener("release", () => {
                console.log("Wake Lock rilasciato dal sistema");
                wakeLockSentinel = null;
              });
            }
          } catch (err) {
            console.warn("Wake Lock non disponibile:", err.message);
          }
        }

        async function releaseWakeLock() {
          if (wakeLockSentinel) {
            try {
              await wakeLockSentinel.release();
              console.log("Wake Lock rilasciato manualmente");
            } catch (err) {
              console.warn("Errore nel rilascio Wake Lock:", err.message);
            } finally {
              wakeLockSentinel = null;
            }
          }
        }

        // Keep-alive ogni 8 secondi (più aggressivo)
        function startKeepAlive() {
          if (keepAliveTimer) return;

          keepAliveTimer = setInterval(() => {
            if (
              !audio.paused &&
              isFinite(audio.duration) &&
              audio.duration > 0
            ) {
              console.log(
                "Keep-alive tick:",
                audio.currentTime.toFixed(1),
                "/",
                audio.duration.toFixed(1)
              );

              try {
                if (navigator.mediaSession) {
                  navigator.mediaSession.playbackState = "playing";
                }
              } catch (e) {}

              // Aggiorna posizione forzatamente
              updatePositionState(true);
            }
          }, 8000);
        }

        function stopKeepAlive() {
          if (keepAliveTimer) {
            clearInterval(keepAliveTimer);
            keepAliveTimer = null;
          }
        }

        function setupMediaSession() {
          if (!("mediaSession" in navigator)) return;
          if (mediaSessionReady) return;

          try {
            const artworkUrl =
              container.dataset.audioPoster ||
              "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23667' width='100' height='100'/%3E%3Cpath fill='%23fff' d='M35 25l40 25-40 25z'/%3E%3C/svg%3E";

            const metadata = {
              title: title || "Audio Lesson",
              artist: "Podcast",
              album: "Learning",
              artwork: [
                { src: artworkUrl, sizes: "96x96", type: "image/png" },
                { src: artworkUrl, sizes: "128x128", type: "image/png" },
                { src: artworkUrl, sizes: "192x192", type: "image/png" },
                { src: artworkUrl, sizes: "256x256", type: "image/png" },
                { src: artworkUrl, sizes: "384x384", type: "image/png" },
                { src: artworkUrl, sizes: "512x512", type: "image/png" },
              ],
            };

            navigator.mediaSession.metadata = new MediaMetadata(metadata);

            navigator.mediaSession.setActionHandler("play", () => {
              audio.play().catch((err) => {
                console.warn("Play error:", err.message);
              });
            });

            navigator.mediaSession.setActionHandler("pause", () => {
              audio.pause();
            });

            navigator.mediaSession.setActionHandler(
              "seekbackward",
              (details) => {
                const skip = (details && details.seekOffset) || 10;
                audio.currentTime = Math.max(0, audio.currentTime - skip);
                updatePositionState(true);
              }
            );

            navigator.mediaSession.setActionHandler(
              "seekforward",
              (details) => {
                const skip = (details && details.seekOffset) || 10;
                audio.currentTime = Math.min(
                  audio.duration,
                  audio.currentTime + skip
                );
                updatePositionState(true);
              }
            );

            navigator.mediaSession.setActionHandler("seekto", (details) => {
              if (details && typeof details.seekTime === "number") {
                const seekTime = Math.max(
                  0,
                  Math.min(details.seekTime, audio.duration)
                );
                audio.currentTime = seekTime;
                // Aggiorna subito dopo il seek
                setTimeout(() => updatePositionState(true), 50);
              }
            });

            navigator.mediaSession.setActionHandler("stop", () => {
              audio.pause();
              audio.currentTime = 0;
              updatePositionState(true);
            });

            try {
              navigator.mediaSession.setActionHandler("previoustrack", null);
              navigator.mediaSession.setActionHandler("nexttrack", null);
            } catch (e) {}

            mediaSessionReady = true;
            console.log("Media Session configurata");
          } catch (e) {
            console.warn("Media Session setup error:", e);
          }
        }

        // force = true forza l'aggiornamento anche se poco è cambiato
        function updatePositionState(force = false) {
          if (!("mediaSession" in navigator)) return;
          if (!navigator.mediaSession.setPositionState) return;
          if (!mediaSessionReady) return;

          try {
            const duration = audio.duration;
            const currentTime = audio.currentTime;
            const playbackRate = audio.playbackRate;

            // Validazione minima
            if (!isFinite(duration) || duration <= 0) return;
            if (!isFinite(currentTime) || currentTime < 0) return;
            if (!isFinite(playbackRate) || playbackRate <= 0) return;

            // Se siamo molto vicino alla fine, non aggiornare
            if (currentTime >= duration - 0.1 && audio.ended) {
              return;
            }

            // Throttle: aggiorna massimo ogni 500ms
            const now = Date.now();
            if (!force && now - lastUpdateTime < 500) {
              return;
            }

            lastUpdateTime = now;

            navigator.mediaSession.setPositionState({
              duration: duration,
              playbackRate: playbackRate,
              position: Math.max(0, Math.min(currentTime, duration)),
            });

            console.log(
              "Position updated:",
              currentTime.toFixed(1),
              "/",
              duration.toFixed(1)
            );
          } catch (e) {
            console.warn("Position state error:", e.message);
          }
        }

        // Play
        audio.addEventListener("play", () => {
          if (!mediaSessionReady) {
            setupMediaSession();
          }

          try {
            if (navigator.mediaSession) {
              navigator.mediaSession.playbackState = "playing";
            }
          } catch (e) {}

          requestWakeLock();
          startKeepAlive();
          setTimeout(() => updatePositionState(true), 100);
        });

        // Pause
        audio.addEventListener("pause", () => {
          try {
            if (navigator.mediaSession) {
              navigator.mediaSession.playbackState = "paused";
            }
          } catch (e) {}

          stopKeepAlive();
          releaseWakeLock();
          updatePositionState(true);
        });

        // Ended
        audio.addEventListener("ended", () => {
          try {
            if (navigator.mediaSession) {
              navigator.mediaSession.playbackState = "none";
            }
          } catch (e) {}

          stopKeepAlive();
          releaseWakeLock();
          updatePositionState(true);
        });

        // Error
        audio.addEventListener("error", (e) => {
          console.error("Audio error:", e);
          try {
            if (navigator.mediaSession) {
              navigator.mediaSession.playbackState = "none";
            }
          } catch (err) {}

          stopKeepAlive();
          releaseWakeLock();
          mediaSessionReady = false;
        });

        // Throttled timeupdate
        let lastTimeUpdateEvent = 0;
        audio.addEventListener("timeupdate", () => {
          const now = Date.now();
          if (
            now - lastTimeUpdateEvent > 1000 &&
            !audio.paused &&
            audio.readyState >= 2
          ) {
            lastTimeUpdateEvent = now;
            updatePositionState();
          }
        });

        // Seeked
        audio.addEventListener("seeked", () => {
          console.log("Seeked to:", audio.currentTime.toFixed(1));
          setTimeout(() => updatePositionState(true), 100);
        });

        // Metadata loaded
        audio.addEventListener("loadedmetadata", () => {
          if (!mediaSessionReady) {
            setupMediaSession();
          }
          setTimeout(() => updatePositionState(true), 200);
        });

        // Rate change
        audio.addEventListener("ratechange", () => {
          updatePositionState(true);
        });

        // Visibilità
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible" && !audio.paused) {
            requestWakeLock();
            setTimeout(() => updatePositionState(true), 100);
          }
        });

        // Initial setup
        if (audio.readyState >= 2) {
          setupMediaSession();
          setTimeout(() => updatePositionState(true), 200);
        }

        // Cleanup
        const cleanup = () => {
          stopKeepAlive();
          releaseWakeLock();
        };

        window.addEventListener("beforeunload", cleanup);
        window.addEventListener("unload", cleanup);
      } catch (e) {
        console.error("AudioPlayer component error:", e);
      }
    })();
  </script>
</div>

<style>
  .audio-player {
    margin: 0.75rem 0 1.25rem 0;
  }
</style>
