---
import type { Props } from "@astrojs/starlight/props";
import SiteTitle from "@astrojs/starlight/components/SiteTitle.astro";
import Search from "@astrojs/starlight/components/Search.astro";
import SocialIcons from "@astrojs/starlight/components/SocialIcons.astro";
import ThemeSelect from "starlight-theme-galaxy/overrides/ThemeSelect.astro";
import LanguageSelect from "@astrojs/starlight/components/LanguageSelect.astro";
import ProgressScroll from "starlight-theme-galaxy/components/ProgressScroll.astro";
import brandIcon from "@assets/images/brand-icon.png";
import { headerNav } from "../config/header";

// Logic to hide progress scroll on homepage (optional, based on Galaxy theme docs)
const baseUrl = import.meta.env.BASE_URL || "/";
const normalizedPath = Astro.url.pathname.endsWith("/")
    ? Astro.url.pathname
    : Astro.url.pathname + "/";
const normalizedBase = baseUrl.endsWith("/") ? baseUrl : baseUrl + "/";
const displayProgressScroll = normalizedPath !== normalizedBase;
---

<div class="header custom-header-container sl-flex">
    <div class="left-group sl-flex">
        <div class="title-wrapper sl-flex">
            <a href={import.meta.env.BASE_URL} class="brand-logo">
                <img src={brandIcon.src} alt="Brand Logo" />
            </a>
            <SiteTitle {...Astro.props} />
        </div>

        <!-- Mobile menu button (three dots) - visible only on mobile -->
        <!-- Mobile menu button (three dots) - visible only on mobile -->
        {
            headerNav.length > 0 && (
                <button
                    class="mobile-menu-btn"
                    aria-label="Open navigation menu"
                >
                    <svg
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <circle cx="12" cy="12" r="1" />
                        <circle cx="19" cy="12" r="1" />
                        <circle cx="5" cy="12" r="1" />
                    </svg>
                </button>
            )
        }

        <div class="nav-wrapper sl-flex">
            <nav class="top-nav">
                <ul>
                    {
                        headerNav.map((item) => (
                            <li>
                                {item.items ? (
                                    <div class="dropdown">
                                        <button class="dropdown-btn">
                                            {item.icon && (
                                                <span class="nav-icon">
                                                    {item.icon}
                                                </span>
                                            )}
                                            {item.label}
                                            <svg
                                                width="12"
                                                height="12"
                                                viewBox="0 0 24 24"
                                                fill="none"
                                                stroke="currentColor"
                                                stroke-width="2"
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                class="caret"
                                            >
                                                <path d="m6 9 6 6 6-6" />
                                            </svg>
                                        </button>
                                        <ul class="dropdown-content">
                                            {item.items.map((subItem) => (
                                                <li>
                                                    <a href={subItem.href}>
                                                        {subItem.icon && (
                                                            <span class="nav-icon">
                                                                {subItem.icon}
                                                            </span>
                                                        )}
                                                        {subItem.label}
                                                    </a>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                ) : (
                                    <a href={item.href}>
                                        {item.icon && (
                                            <span class="nav-icon">
                                                {item.icon}
                                            </span>
                                        )}
                                        {item.label}
                                    </a>
                                )}
                            </li>
                        ))
                    }
                </ul>
            </nav>
        </div>
    </div>

    <div class="sl-flex search-wrapper">
        <Search {...Astro.props} />
    </div>

    <div class="sl-hidden md:sl-flex right-group">
        <div class="sl-flex social-icons">
            <SocialIcons {...Astro.props} />
        </div>
        <ThemeSelect {...Astro.props} />
        <LanguageSelect {...Astro.props} />
    </div>
</div>

<!-- Mobile Navigation Drawer -->
<div class="mobile-drawer-overlay" aria-hidden="true"></div>
<div class="mobile-drawer" id="mobileDrawer" aria-hidden="true">
    <div class="mobile-drawer-header">
        <span class="mobile-drawer-title">Menu</span>
        <button class="mobile-drawer-close" aria-label="Close menu">
            <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
            >
                <path d="M17 7 L7 17"></path>
                <path d="M7 7 L17 17"></path>
            </svg>
        </button>
    </div>
    <nav class="mobile-drawer-nav">
        <ul>
            {
                headerNav.map((item) => (
                    <li>
                        {item.items ? (
                            <div class="mobile-dropdown">
                                <button class="mobile-dropdown-btn">
                                    {item.icon && (
                                        <span class="nav-icon">
                                            {item.icon}
                                        </span>
                                    )}
                                    {item.label}
                                    <svg
                                        width="12"
                                        height="12"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="mobile-caret"
                                    >
                                        <path d="m6 9 6 6 6-6" />
                                    </svg>
                                </button>
                                <ul class="mobile-dropdown-content">
                                    {item.items.map((subItem) => (
                                        <li>
                                            <a href={subItem.href}>
                                                {subItem.icon && (
                                                    <span class="nav-icon">
                                                        {subItem.icon}
                                                    </span>
                                                )}
                                                {subItem.label}
                                            </a>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        ) : (
                            <a href={item.href}>
                                {item.icon && (
                                    <span class="nav-icon">{item.icon}</span>
                                )}
                                {item.label}
                            </a>
                        )}
                    </li>
                ))
            }
        </ul>
    </nav>
</div>

{displayProgressScroll && <ProgressScroll />}

<script>
    // Logic to handle mobile drawer
    const mobileMenuBtn = document.querySelector(".mobile-menu-btn");
    const mobileDrawer = document.querySelector(".mobile-drawer");
    const mobileDrawerOverlay = document.querySelector(
        ".mobile-drawer-overlay",
    );
    const mobileDrawerClose = document.querySelector(".mobile-drawer-close");

    function toggleDrawer() {
        if (!mobileDrawer || !mobileDrawerOverlay) return;

        const isOpen = mobileDrawer.classList.contains("open");
        if (isOpen) {
            mobileDrawer.classList.remove("open");
            mobileDrawerOverlay.classList.remove("open");
            mobileDrawer.setAttribute("aria-hidden", "true");
            mobileDrawerOverlay.setAttribute("aria-hidden", "true");
            document.body.style.overflow = "";
        } else {
            mobileDrawer.classList.add("open");
            mobileDrawerOverlay.classList.add("open");
            mobileDrawer.setAttribute("aria-hidden", "false");
            mobileDrawerOverlay.setAttribute("aria-hidden", "false");
            document.body.style.overflow = "hidden";
        }
    }

    if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener("click", toggleDrawer);
    }

    if (mobileDrawerClose) {
        mobileDrawerClose.addEventListener("click", toggleDrawer);
    }

    if (mobileDrawerOverlay) {
        mobileDrawerOverlay.addEventListener("click", toggleDrawer);
    }

    // Mobile Dropdown Logic
    const mobileDropdownBtns = document.querySelectorAll(
        ".mobile-dropdown-btn",
    );

    mobileDropdownBtns.forEach((btn) => {
        btn.addEventListener("click", (e) => {
            e.preventDefault();
            const dropdown = btn.closest(".mobile-dropdown");
            if (dropdown) {
                dropdown.classList.toggle("open");
            }
        });
    });

    // Dropdown Logic for Desktop
    const dropdownBtn = document.querySelector(".dropdown-btn");
    const dropdown = document.querySelector(".dropdown");

    if (dropdownBtn && dropdown) {
        dropdownBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdown.classList.toggle("open");
        });

        // Close dropdown when clicking outside
        document.addEventListener("click", (e) => {
            if (dropdown && !dropdown.contains(e.target as Node)) {
                dropdown.classList.remove("open");
            }
        });
    }
</script>

<style>
    .header {
        gap: var(--sl-nav-gap);
        justify-content: space-between;
        align-items: center;
        height: 100%;
        display: flex;
    }

    .left-group {
        display: flex;
        align-items: center;
        gap: 2rem;
    }

    .title-wrapper {
        flex-shrink: 0;
        align-items: center;
        gap: 0.5rem;
    }

    .brand-logo img {
        height: 32px;
        width: auto;
        display: block;
    }

    .nav-wrapper {
        display: none;
    }

    @media (min-width: 50rem) {
        .nav-wrapper {
            display: flex;
        }
    }

    .top-nav > ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }

    .top-nav li {
        position: relative;
    }

    .top-nav a,
    .dropdown-btn {
        text-decoration: none;
        color: var(--sl-color-white);
        font-size: var(--sl-text-sm);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem 0;
        white-space: nowrap;
    }

    .top-nav a:hover,
    .dropdown-btn:hover {
        color: var(--sl-color-accent-high);
    }

    /* Icon styles */
    .nav-icon {
        margin-right: 0.25rem;
        font-size: 1.1em;
        vertical-align: middle;
    }

    /* Dropdown Styles */
    .dropdown-content {
        position: absolute;
        top: 100%;
        left: 0;
        background-color: var(--sl-color-bg-nav);
        border: 1px solid var(--sl-color-gray-5);
        border-radius: 0.5rem;
        padding: 0.5rem;
        min-width: 180px;
        display: none;
        flex-direction: column;
        gap: 0.25rem;
        box-shadow: var(--sl-shadow-md);
        z-index: 1000;
        margin-top: 0.5rem;
    }

    .dropdown.open .dropdown-content {
        display: flex;
    }

    .dropdown-content li {
        width: 100%;
    }

    .dropdown-content a {
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        display: block;
        width: 100%;
    }

    .dropdown-content a:hover {
        background-color: var(--sl-color-gray-6);
        color: var(--sl-color-white);
    }

    .search-wrapper {
        display: flex;
        justify-content: flex-end;
        margin: 0 1rem;
    }

    /* Desktop: Expand search bar */
    @media (min-width: 50rem) {
        .search-wrapper {
            flex-grow: 1;
            justify-content: center;
            width: 100%;
            max-width: 100%;
        }

        /* Force search button to take available space */
        .search-wrapper :global(site-search),
        .search-wrapper :global(.site-search) {
            width: 100%;
            max-width: 100%;
        }

        .search-wrapper :global(button[data-open-modal]) {
            width: 100% !important;
            border: 1px solid var(--sl-color-gray-5);
            border-radius: 0.5rem;
            padding-inline: 1rem;
            justify-content: space-between;
        }
    }

    .right-group {
        gap: 1rem;
        align-items: center;
    }

    .social-icons a {
        color: var(--sl-color-text-accent);
    }

    .social-icons a:hover {
        color: var(--sl-color-white);
    }

    /* Mobile Drawer Styles */
    .mobile-drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition:
            opacity 0.3s ease,
            visibility 0.3s ease;
    }

    .mobile-drawer-overlay.open {
        opacity: 1;
        visibility: visible;
    }

    .mobile-drawer {
        position: fixed;
        top: 0;
        left: 0;
        width: 80%;
        max-width: 300px;
        height: 100vh !important; /* Force full height */
        background-color: var(--sl-color-bg-nav);
        z-index: 9999;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        box-shadow: var(--sl-shadow-xl);
        display: flex;
        flex-direction: column;
        overflow-y: auto; /* Allow scrolling within drawer */
    }

    .mobile-drawer.open {
        transform: translateX(0);
    }

    .mobile-drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--sl-color-gray-5);
    }

    .mobile-drawer-title {
        font-size: var(--sl-text-lg);
        font-weight: 600;
        color: var(--sl-color-white);
    }

    .mobile-drawer-close {
        background: none;
        border: none;
        color: var(--sl-color-gray-3);
        cursor: pointer;
        padding: 0.5rem;
    }

    .mobile-drawer-close:hover {
        color: var(--sl-color-white);
    }

    .mobile-drawer-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .mobile-drawer-nav a,
    .mobile-dropdown-btn {
        display: block;
        padding: 1rem;
        color: var(--sl-color-text); /* Use theme text color */
        text-decoration: none;
        border-bottom: 1px solid var(--sl-color-gray-5);
        font-size: var(--sl-text-base);
        width: 100%;
        text-align: left;
        background: none;
        border: none;
        cursor: pointer;
    }

    .mobile-drawer-nav a:hover,
    .mobile-dropdown-btn:hover {
        background-color: var(--sl-color-gray-6);
        color: var(--sl-color-white);
    }

    /* Mobile Dropdown */
    .mobile-dropdown-content {
        display: none;
        background-color: var(--sl-color-bg-sidebar);
        padding-left: 1rem;
    }

    .mobile-dropdown.open .mobile-dropdown-content {
        display: block;
    }

    .mobile-caret {
        margin-left: 0.5rem;
        transition: transform 0.2s ease;
    }

    .mobile-dropdown.open .mobile-caret {
        transform: rotate(180deg);
    }

    .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        color: var(--sl-color-white);
        cursor: pointer;
        padding: 0.5rem;
    }

    /* Mobile Layout Fixes */

    /* 1. Reserve space for Starlight's hamburger menu and ensure flexible layout */
    @media (max-width: 49.9375rem) {
        .custom-header-container {
            padding-right: 1.5rem !important; /* Reduced reserved space for Starlight hamburger */
            gap: 0 !important; /* Remove gap between groups to tighten spacing */
        }

        /* Ensure left group takes available space */
        .left-group {
            flex: 1;
            max-width: 100%;
            min-width: 0; /* Allow shrinking */
            align-items: center;
            gap: 0.5rem !important; /* Reduce gap on mobile */
        }

        /* Allow title to shrink if needed but GROW to fill space */
        .title-wrapper {
            flex: 1 1 auto !important; /* Grow to fill space, shrink if needed */
            min-width: 0;
            overflow: hidden;
            margin-right: 0; /* Remove margin to bring dots closer */
        }

        /* Prevent logo from shrinking */
        .brand-logo,
        .brand-logo img {
            flex-shrink: 0 !important;
        }

        /* Force truncation on the title text elements */
        .title-wrapper :global(a),
        .title-wrapper :global(span),
        .site-title {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        /* Prevent mobile menu button from shrinking */
        .mobile-menu-btn {
            flex: 0 0 auto;
            margin-right: 0.25rem; /* Small gap between dots and search */
            display: block; /* Show on mobile */
        }
    }

    /* 2. Ensure search icon is ALWAYS visible on mobile */
    @media (max-width: 49.9375rem) {
        .search-wrapper {
            display: flex !important;
            flex: 0 0 auto !important;
            width: auto !important;
            height: auto !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            margin: 0 !important; /* Remove margin to bring search closer to dots and edge */
        }

        .search-wrapper button {
            display: flex !important;
            width: auto !important;
            height: auto !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            padding-inline: 0.5rem !important; /* Reduce internal padding of search button if needed */
        }

        .search-wrapper :global(.sl-hidden) {
            display: none !important;
        }
    }
</style>
