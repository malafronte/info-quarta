---
import type { Props } from "@astrojs/starlight/props";
import SiteTitle from "@astrojs/starlight/components/SiteTitle.astro";
import Search from "@astrojs/starlight/components/Search.astro";
import SocialIcons from "@astrojs/starlight/components/SocialIcons.astro";
import ThemeSelect from "starlight-theme-galaxy/overrides/ThemeSelect.astro";
import LanguageSelect from "@astrojs/starlight/components/LanguageSelect.astro";
import ProgressScroll from "starlight-theme-galaxy/components/ProgressScroll.astro";
import brandIcon from "@assets/images/brand-icon.png";

// Logic to hide progress scroll on homepage (optional, based on Galaxy theme docs)
const baseUrl = import.meta.env.BASE_URL || "/";
const normalizedPath = Astro.url.pathname.endsWith("/")
    ? Astro.url.pathname
    : Astro.url.pathname + "/";
const normalizedBase = baseUrl.endsWith("/") ? baseUrl : baseUrl + "/";
const displayProgressScroll = normalizedPath !== normalizedBase;
---

<div class="header sl-flex">
    <div class="left-group sl-flex">
        <div class="title-wrapper sl-flex">
            <a href={import.meta.env.BASE_URL} class="brand-logo">
                <img src={brandIcon.src} alt="Brand Logo" />
            </a>
            <SiteTitle {...Astro.props} />
        </div>

        <!-- Mobile menu button (three dots) - visible only on mobile -->
        <button class="mobile-menu-btn" aria-label="Open navigation menu">
            <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
            >
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="19" cy="12" r="1"></circle>
                <circle cx="5" cy="12" r="1"></circle>
            </svg>
        </button>

        <div class="nav-wrapper sl-flex">
            <nav class="top-nav">
                <ul>
                    <li><a href="/info-quarta/gemini-cli">Gemini CLI</a></li>
                    <li class="dropdown">
                        <button class="dropdown-btn">
                            Extensions
                            <svg
                                width="12"
                                height="12"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                class="caret"
                            >
                                <path d="m6 9 6 6 6-6"></path>
                            </svg>
                        </button>
                        <ul class="dropdown-content">
                            <li><a href="/info-quarta/gallery">Gallery</a></li>
                            <li>
                                <a href="/info-quarta/about-extensions"
                                    >About Extensions</a
                                >
                            </li>
                        </ul>
                    </li>
                    <li><a href="/info-quarta/docs">Docs</a></li>
                    <li><a href="/info-quarta/changelog">Changelog</a></li>
                </ul>
            </nav>
        </div>
    </div>

    <div class="sl-flex search-wrapper">
        <Search {...Astro.props} />
    </div>

    <div class="sl-hidden md:sl-flex right-group">
        <div class="sl-flex social-icons">
            <SocialIcons {...Astro.props} />
        </div>
        <ThemeSelect {...Astro.props} />
        <LanguageSelect {...Astro.props} />
    </div>
</div>

<!-- Mobile Navigation Drawer -->
<div class="mobile-drawer-overlay" aria-hidden="true"></div>
<div
    class="mobile-drawer"
    role="dialog"
    aria-modal="true"
    aria-label="Navigation menu"
>
    <div class="mobile-drawer-header">
        <span class="mobile-drawer-title">Menu</span>
        <button class="mobile-drawer-close" aria-label="Close navigation menu">
            <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
            >
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
    <nav class="mobile-drawer-nav">
        <ul>
            <li><a href="/info-quarta/gemini-cli">Gemini CLI</a></li>
            <li class="mobile-dropdown">
                <button class="mobile-dropdown-btn">
                    Extensions
                    <svg
                        width="12"
                        height="12"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="mobile-caret"
                    >
                        <path d="m6 9 6 6 6-6"></path>
                    </svg>
                </button>
                <ul class="mobile-dropdown-content">
                    <li><a href="/info-quarta/gallery">Gallery</a></li>
                    <li>
                        <a href="/info-quarta/about-extensions"
                            >About Extensions</a
                        >
                    </li>
                </ul>
            </li>
            <li><a href="/info-quarta/docs">Docs</a></li>
            <li><a href="/info-quarta/changelog">Changelog</a></li>
        </ul>
    </nav>
</div>

{displayProgressScroll && <ProgressScroll />}

<script>
    // Handle dropdown toggling
    function setupDropdowns() {
        const dropdowns = document.querySelectorAll(".dropdown");

        dropdowns.forEach((dropdown) => {
            const btn = dropdown.querySelector(".dropdown-btn");
            const content = dropdown.querySelector(".dropdown-content");

            if (btn && content) {
                // Remove old listeners to prevent duplicates if re-running
                const newBtn = btn.cloneNode(true);
                if (btn.parentNode) {
                    btn.parentNode.replaceChild(newBtn, btn);
                }

                // Toggle on button click
                newBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    // Close other dropdowns first
                    dropdowns.forEach((d) => {
                        if (d !== dropdown) d.classList.remove("open");
                    });
                    dropdown.classList.toggle("open");
                });

                // Close on link click
                const links = content.querySelectorAll("a");
                links.forEach((link) => {
                    link.addEventListener("click", () => {
                        dropdown.classList.remove("open");
                    });
                });
            }
        });

        // Close when clicking outside
        document.addEventListener("click", (e) => {
            const target = e.target;
            if (target instanceof HTMLElement && !target.closest(".dropdown")) {
                dropdowns.forEach((d) => d.classList.remove("open"));
            }
        });
    }

    // Run on initial load
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", setupDropdowns);
    } else {
        setupDropdowns();
    }

    // Support View Transitions (if enabled)
    document.addEventListener("astro:page-load", setupDropdowns);

    // Handle mobile drawer toggling
    function setupMobileDrawer() {
        const menuBtn = document.querySelector(".mobile-menu-btn");
        const drawer = document.querySelector(".mobile-drawer");
        const overlay = document.querySelector(".mobile-drawer-overlay");
        const closeBtn = document.querySelector(".mobile-drawer-close");
        const drawerLinks = document.querySelectorAll(".mobile-drawer-nav a");
        const mobileDropdowns = document.querySelectorAll(".mobile-dropdown");

        if (!menuBtn || !drawer || !overlay || !closeBtn) {
            console.log("Mobile drawer elements not found");
            return;
        }

        // Clone menu button to remove old listeners
        const newMenuBtn = menuBtn.cloneNode(true);
        if (menuBtn.parentNode) {
            menuBtn.parentNode.replaceChild(newMenuBtn, menuBtn);
        }

        // Clone close button to remove old listeners
        const newCloseBtn = closeBtn.cloneNode(true);
        if (closeBtn.parentNode) {
            closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
        }

        // Open drawer
        newMenuBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            console.log("Opening drawer");
            drawer.classList.add("open");
            overlay.classList.add("open");
            document.body.style.overflow = "hidden"; // Prevent scrolling
        });

        // Close drawer
        const closeDrawer = () => {
            console.log("Closing drawer");
            drawer.classList.remove("open");
            overlay.classList.remove("open");
            document.body.style.overflow = "";
        };

        newCloseBtn.addEventListener("click", closeDrawer);
        overlay.addEventListener("click", closeDrawer);

        // Close drawer when clicking on a link (except dropdown buttons)
        drawerLinks.forEach((link) => {
            link.addEventListener("click", closeDrawer);
        });

        // Handle mobile dropdown toggles inside drawer
        mobileDropdowns.forEach((dropdown) => {
            const btn = dropdown.querySelector(".mobile-dropdown-btn");
            if (btn) {
                btn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    dropdown.classList.toggle("open");
                });
            }
        });
    }

    // Run mobile drawer setup on initial load
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", setupMobileDrawer);
    } else {
        setupMobileDrawer();
    }

    // Support View Transitions (if enabled)
    document.addEventListener("astro:page-load", setupMobileDrawer);
</script>

<style>
    .header {
        gap: var(--sl-nav-gap);
        justify-content: space-between;
        align-items: center;
        height: 100%;
        display: flex;
    }

    .left-group {
        display: flex;
        align-items: center;
        gap: 2rem;
    }

    .title-wrapper {
        flex-shrink: 0;
        align-items: center;
        gap: 0.5rem;
    }

    .brand-logo img {
        height: 32px;
        width: auto;
        display: block;
    }

    .nav-wrapper {
        display: none;
    }

    @media (min-width: 50rem) {
        .nav-wrapper {
            display: flex;
        }
    }

    .top-nav > ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }

    .top-nav li {
        position: relative;
    }

    .top-nav a,
    .dropdown-btn {
        text-decoration: none;
        color: var(--sl-color-white);
        font-size: var(--sl-text-sm);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem 0;
        white-space: nowrap;
    }

    .top-nav a:hover,
    .dropdown-btn:hover {
        color: var(--sl-color-accent-high);
    }

    /* Dropdown Styles */
    .dropdown-content {
        position: absolute;
        top: 100%;
        left: 0;
        background-color: var(--sl-color-bg-nav);
        border: 1px solid var(--sl-color-gray-5);
        border-radius: 0.5rem;
        padding: 0.5rem;
        min-width: 180px;
        display: none;
        flex-direction: column;
        gap: 0.25rem;
        box-shadow: var(--sl-shadow-md);
        z-index: 1000;
        margin-top: 0.5rem;
    }

    .dropdown.open .dropdown-content {
        display: flex;
    }

    .dropdown-content li {
        width: 100%;
    }

    .dropdown-content a {
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        display: block;
        width: 100%;
    }

    .dropdown-content a:hover {
        background-color: var(--sl-color-gray-6);
        color: var(--sl-color-white);
    }

    .search-wrapper {
        display: flex;
        justify-content: flex-end;
        margin: 0 1rem;
    }

    /* Desktop: Expand search bar */
    @media (min-width: 50rem) {
        .search-wrapper {
            flex-grow: 1;
            justify-content: center;
            width: 100%;
            max-width: 100%;
        }

        /* Force search button to take available space */
        .search-wrapper :global(site-search),
        .search-wrapper :global(.site-search) {
            width: 100%;
            max-width: 100%;
        }

        .search-wrapper :global(button[data-open-modal]) {
            width: 100% !important;
            border: 1px solid var(--sl-color-gray-5);
            border-radius: 0.5rem;
            padding-inline: 1rem;
            justify-content: space-between;
        }
    }

    /* Mobile: Ensure icon only */
    @media (max-width: 49.9375rem) {
        .search-wrapper {
            flex-grow: 0 !important;
            width: auto !important;
        }

        .search-wrapper :global(button[data-open-modal]) {
            border: none !important;
            background: transparent !important;
            padding: 0.5rem !important;
            width: auto !important;
        }

        .search-wrapper :global(.sl-hidden) {
            display: none !important;
        }
    }

    .right-group {
        gap: 1rem;
        align-items: center;
        height: 100%;
    }

    .social-icons {
        gap: 1rem;
        align-items: center;
        display: flex;
        height: 100%;
    }

    .social-icons :global(a) {
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--sl-color-text-accent);
        text-decoration: none;
        line-height: 1;
        height: 100%;
    }

    .social-icons :global(svg) {
        display: block;
        vertical-align: middle;
    }

    .social-icons :global(a:hover) {
        color: var(--sl-color-white);
    }

    @media (min-width: 50rem) {
        :global(:root[data-has-sidebar]) {
            --sl-content-width: 67.5rem;
        }
    }

    /* Mobile Menu Button - visible only on mobile when nav is hidden */
    .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        color: var(--sl-color-white);
        cursor: pointer;
        padding: 0.5rem;
        margin-left: 0.5rem;
        align-items: center;
        justify-content: center;
        transition: opacity 0.2s;
        flex-shrink: 0;
    }

    .mobile-menu-btn:hover {
        opacity: 0.8;
    }

    @media (max-width: 49.9375rem) {
        .mobile-menu-btn {
            display: flex;
        }
    }

    /* Mobile Drawer Overlay */
    .mobile-drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        opacity: 0;
        visibility: hidden;
        transition:
            opacity 0.3s,
            visibility 0.3s;
        z-index: 9998;
    }

    .mobile-drawer-overlay.open {
        opacity: 1;
        visibility: visible;
    }

    /* Mobile Drawer Panel */
    .mobile-drawer {
        position: fixed;
        top: 0;
        left: 0;
        width: 80%;
        max-width: 320px;
        height: 100%;
        background: var(--sl-color-bg-nav);
        box-shadow: 4px 0 24px rgba(0, 0, 0, 0.3);
        transform: translateX(-100%);
        transition: transform 0.3s ease-out;
        z-index: 9999;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .mobile-drawer.open {
        transform: translateX(0);
    }

    /* Mobile Drawer Header */
    .mobile-drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--sl-color-gray-5);
    }

    .mobile-drawer-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--sl-color-white);
    }

    .mobile-drawer-close {
        background: none;
        border: none;
        color: var(--sl-color-white);
        cursor: pointer;
        padding: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.2s;
    }

    .mobile-drawer-close:hover {
        opacity: 0.8;
    }

    /* Mobile Drawer Navigation */
    .mobile-drawer-nav {
        flex: 1;
        padding: 0;
        overflow-y: auto;
    }

    .mobile-drawer-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .mobile-drawer-nav > ul > li {
        border-bottom: 1px solid var(--sl-color-gray-6);
    }

    .mobile-drawer-nav > ul > li > a {
        display: block;
        padding: 1rem 1.25rem;
        color: var(--sl-color-white);
        text-decoration: none;
        font-size: 1rem;
        transition: background-color 0.2s;
    }

    .mobile-drawer-nav > ul > li > a:hover {
        background-color: var(--sl-color-gray-6);
    }

    /* Mobile Dropdown in Drawer */
    .mobile-dropdown {
        position: relative;
    }

    .mobile-dropdown-btn {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 1rem 1.25rem;
        background: none;
        border: none;
        color: var(--sl-color-white);
        font-size: 1rem;
        cursor: pointer;
        text-align: left;
        transition: background-color 0.2s;
    }

    .mobile-dropdown-btn:hover {
        background-color: var(--sl-color-gray-6);
    }

    .mobile-caret {
        transition: transform 0.2s;
        flex-shrink: 0;
        margin-left: 0.5rem;
    }

    .mobile-dropdown.open .mobile-caret {
        transform: rotate(180deg);
    }

    .mobile-dropdown-content {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background-color: var(--sl-color-gray-7);
    }

    .mobile-dropdown.open .mobile-dropdown-content {
        max-height: 500px;
    }

    .mobile-dropdown-content li {
        border-top: 1px solid var(--sl-color-gray-6);
    }

    .mobile-dropdown-content a {
        display: block;
        padding: 0.875rem 1.25rem 0.875rem 2.5rem;
        color: var(--sl-color-gray-2);
        text-decoration: none;
        font-size: 0.9375rem;
        transition: background-color 0.2s;
    }

    .mobile-dropdown-content a:hover {
        background-color: var(--sl-color-gray-6);
        color: var(--sl-color-white);
    }

    /* Responsive visibility control - aligned at 50rem (800px) */
    /* Hide navigation and show mobile menu below 800px */
    @media (max-width: 49.9375rem) {
        .nav-wrapper {
            display: none !important;
        }

        .mobile-menu-btn {
            display: flex !important;
        }
    }

    /* Show navigation and hide mobile menu above 800px */
    @media (min-width: 50rem) {
        .nav-wrapper {
            display: flex !important;
        }

        .mobile-menu-btn {
            display: none !important;
        }
    }

    /* Fix drawer to occupy full viewport height */
    .mobile-drawer {
        height: 100vh !important;
        min-height: 100vh !important;
    }

    /* Ensure mobile menu button doesn't overlap with Starlight hamburger */
    @media (max-width: 71.9375rem) {
        .mobile-menu-btn {
            margin-right: 0.5rem;
        }
    }

    /* CRITICAL FIXES for visibility */
    .mobile-drawer-nav > ul > li > a,
    .mobile-dropdown-btn {
        color: var(--sl-color-text) !important;
        opacity: 1 !important;
        visibility: visible !important;
    }

    .mobile-drawer-nav,
    .mobile-drawer-nav > ul,
    .mobile-drawer-nav > ul > li {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Fix search wrapper expansion on mobile */
    @media (max-width: 49.9375rem) {
        .search-wrapper {
            flex: 0 0 auto !important;
            max-width: fit-content !important;
        }
    }
</style>
