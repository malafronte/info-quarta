---
import type { Props } from "@astrojs/starlight/props";
import SiteTitle from "@astrojs/starlight/components/SiteTitle.astro";
import Search from "@astrojs/starlight/components/Search.astro";
import SocialIcons from "@astrojs/starlight/components/SocialIcons.astro";
import ThemeSelect from "starlight-theme-galaxy/overrides/ThemeSelect.astro";
import LanguageSelect from "@astrojs/starlight/components/LanguageSelect.astro";
import ProgressScroll from "starlight-theme-galaxy/components/ProgressScroll.astro";
import brandIcon from "@assets/images/brand-icon.png";
import { headerNav, siteTitle, socialLinks } from "../config/header";
import ScrollUpButton from "./ScrollUpButton.astro";

// Logic to hide progress scroll on homepage (optional, based on Galaxy theme docs)
const baseUrl = import.meta.env.BASE_URL || "/";
const normalizedPath = Astro.url.pathname.endsWith("/")
    ? Astro.url.pathname
    : Astro.url.pathname + "/";
const normalizedBase = baseUrl.endsWith("/") ? baseUrl : baseUrl + "/";
const displayProgressScroll = normalizedPath !== normalizedBase;
---

<div class="header custom-header-container sl-flex">
    <div class="left-group sl-flex">
        <div class="title-wrapper sl-flex">
            <a href={import.meta.env.BASE_URL} class="brand-logo">
                <img src={brandIcon.src} alt="Brand Logo" />
            </a>
            <SiteTitle {...Astro.props} />
        </div>

        <!-- Mobile menu button (three dots) - visible only on mobile -->
        <!-- Mobile menu button (three dots) - visible only on mobile -->
        {
            headerNav.length > 0 && (
                <button
                    class="mobile-menu-btn"
                    aria-label="Open navigation menu"
                >
                    <svg
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <circle cx="12" cy="12" r="1" />
                        <circle cx="19" cy="12" r="1" />
                        <circle cx="5" cy="12" r="1" />
                    </svg>
                </button>
            )
        }

        <div class="nav-wrapper sl-flex">
            <nav class="top-nav">
                <ul>
                    {
                        headerNav.map((item) => (
                            <li>
                                {item.items ? (
                                    <div class="dropdown">
                                        <button class="dropdown-btn">
                                            {item.icon && (
                                                <span class="nav-icon">
                                                    {item.icon}
                                                </span>
                                            )}
                                            {item.label}
                                            <svg
                                                width="12"
                                                height="12"
                                                viewBox="0 0 24 24"
                                                fill="none"
                                                stroke="currentColor"
                                                stroke-width="2"
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                class="caret"
                                            >
                                                <path d="m6 9 6 6 6-6" />
                                            </svg>
                                        </button>
                                        <ul class="dropdown-content">
                                            {item.items.map((subItem) => (
                                                <li>
                                                    <a href={subItem.href}>
                                                        {subItem.icon && (
                                                            <span class="nav-icon">
                                                                {subItem.icon}
                                                            </span>
                                                        )}
                                                        {subItem.label}
                                                    </a>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                ) : (
                                    <a href={item.href}>
                                        {item.icon && (
                                            <span class="nav-icon">
                                                {item.icon}
                                            </span>
                                        )}
                                        {item.label}
                                    </a>
                                )}
                            </li>
                        ))
                    }
                </ul>
            </nav>
        </div>
    </div>

    <div class="sl-flex search-wrapper">
        <Search {...Astro.props} />
    </div>

    <div class="sl-hidden md:sl-flex right-group">
        <div class="sl-flex social-icons">
            <SocialIcons {...Astro.props} />
        </div>
        <ThemeSelect {...Astro.props} />
        <LanguageSelect {...Astro.props} />
    </div>
</div>

<!-- Mobile Navigation Drawer -->
<div class="mobile-drawer-overlay" aria-hidden="true"></div>
<div class="mobile-drawer" id="mobileDrawer" aria-hidden="true">
    <div class="mobile-drawer-header">
        <span class="mobile-drawer-title">{siteTitle}</span>
        <button class="mobile-drawer-close" aria-label="Close menu">
            <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
            >
                <path d="M17 7 L7 17"></path>
                <path d="M7 7 L17 17"></path>
            </svg>
        </button>
    </div>

    <!-- Social Links and Theme Selector Row -->
    <div class="mobile-drawer-actions">
        <div class="mobile-drawer-social">
            <a
                href={socialLinks.github}
                target="_blank"
                rel="noopener noreferrer"
                aria-label="GitHub"
            >
                <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                >
                    <path
                        d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
                    ></path>
                </svg>
            </a>
            <a
                href={socialLinks.linkedin}
                target="_blank"
                rel="noopener noreferrer"
                aria-label="LinkedIn"
            >
                <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                >
                    <path
                        d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"
                    ></path>
                </svg>
            </a>
        </div>
        <ThemeSelect {...Astro.props} />
    </div>

    <nav class="mobile-drawer-nav">
        <ul>
            {
                headerNav.map((item) => (
                    <li>
                        {item.items ? (
                            <div class="mobile-dropdown">
                                <button class="mobile-dropdown-btn">
                                    {item.icon && (
                                        <span class="nav-icon">
                                            {item.icon}
                                        </span>
                                    )}
                                    {item.label}
                                    <svg
                                        width="12"
                                        height="12"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="mobile-caret"
                                    >
                                        <path d="m6 9 6 6 6-6" />
                                    </svg>
                                </button>
                                <ul class="mobile-dropdown-content">
                                    {item.items.map((subItem) => (
                                        <li>
                                            <a href={subItem.href}>
                                                {subItem.icon && (
                                                    <span class="nav-icon">
                                                        {subItem.icon}
                                                    </span>
                                                )}
                                                {subItem.label}
                                            </a>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        ) : (
                            <a href={item.href}>
                                {item.icon && (
                                    <span class="nav-icon">{item.icon}</span>
                                )}
                                {item.label}
                            </a>
                        )}
                    </li>
                ))
            }
        </ul>
    </nav>
</div>

{displayProgressScroll && <ProgressScroll />}

<ScrollUpButton />

<script>
    // Logic to handle mobile drawer
    const mobileMenuBtn = document.querySelector(".mobile-menu-btn");
    const mobileDrawer = document.querySelector(".mobile-drawer");
    const mobileDrawerOverlay = document.querySelector(
        ".mobile-drawer-overlay",
    );
    const mobileDrawerClose = document.querySelector(".mobile-drawer-close");

    function toggleDrawer() {
        if (!mobileDrawer || !mobileDrawerOverlay) return;

        const isOpen = mobileDrawer.classList.contains("open");
        if (isOpen) {
            // Move focus back to menu button before closing to avoid aria-hidden warning
            if (mobileMenuBtn instanceof HTMLElement) {
                mobileMenuBtn.focus();
            }

            mobileDrawer.classList.remove("open");
            mobileDrawerOverlay.classList.remove("open");
            mobileDrawer.setAttribute("aria-hidden", "true");
            mobileDrawerOverlay.setAttribute("aria-hidden", "true");
            document.body.style.overflow = "";
        } else {
            mobileDrawer.classList.add("open");
            mobileDrawerOverlay.classList.add("open");
            mobileDrawer.setAttribute("aria-hidden", "false");
            mobileDrawerOverlay.setAttribute("aria-hidden", "false");
            document.body.style.overflow = "hidden";
        }
    }

    if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener("click", toggleDrawer);
    }

    if (mobileDrawerClose) {
        mobileDrawerClose.addEventListener("click", toggleDrawer);
    }

    if (mobileDrawerOverlay) {
        mobileDrawerOverlay.addEventListener("click", toggleDrawer);
    }

    // Mobile Dropdown Logic
    const mobileDropdownBtns = document.querySelectorAll(
        ".mobile-dropdown-btn",
    );

    mobileDropdownBtns.forEach((btn) => {
        btn.addEventListener("click", (e) => {
            e.preventDefault();
            const dropdown = btn.closest(".mobile-dropdown");
            if (dropdown) {
                dropdown.classList.toggle("open");
            }
        });
    });

    // Dropdown Logic for Desktop
    const dropdownBtn = document.querySelector(".dropdown-btn");
    const dropdown = document.querySelector(".dropdown");

    if (dropdownBtn && dropdown) {
        dropdownBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdown.classList.toggle("open");
        });

        // Close dropdown when clicking outside
        document.addEventListener("click", (e) => {
            if (dropdown && !dropdown.contains(e.target as Node)) {
                dropdown.classList.remove("open");
            }
        });
    }
</script>

<style>
    /* Override Galaxy theme's transparent header with solid background */
    :global(.header),
    :global(header),
    :global(.sl-header),
    :global([data-has-hero] header) {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        background: var(--sl-color-bg-nav) !important;
        background-color: var(--sl-color-bg-nav) !important;
        opacity: 1 !important;
    }

    .header {
        gap: var(--sl-nav-gap);
        justify-content: space-between;
        align-items: center;
        height: 100%;
        display: flex;
        background: transparent !important; /* Revert to transparent to avoid overlap rectangle */
        padding-right: 1.5rem; /* Prevent right-side items from being cut off */
        box-sizing: border-box; /* Ensure padding is included in width */
        width: 100%; /* Ensure it doesn't exceed parent */
    }

    .left-group {
        display: flex;
        align-items: center;
        gap: 2.5rem; /* Increase gap between title and nav links */
    }

    .title-wrapper {
        flex-shrink: 0;
        align-items: center;
        gap: 0.5rem;
    }

    .brand-logo img {
        height: 32px;
        width: auto;
        display: block;
    }

    .nav-wrapper {
        display: none;
    }

    @media (min-width: 72rem) {
        .nav-wrapper {
            display: flex;
        }
    }

    .top-nav > ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }

    .top-nav li {
        position: relative;
    }

    .top-nav a,
    .dropdown-btn {
        text-decoration: none;
        color: var(--sl-color-white);
        font-size: var(--sl-text-sm);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem 0;
        white-space: nowrap;
    }

    .top-nav a:hover,
    .dropdown-btn:hover {
        color: var(--sl-color-accent-high);
    }

    /* Icon styles */
    .nav-icon {
        margin-right: 0.25rem;
        font-size: 1.1em;
        vertical-align: middle;
    }

    /* Dropdown Styles */
    .dropdown-content {
        position: absolute;
        top: 100%;
        left: 0;
        background-color: var(--sl-color-bg-nav);
        border: 1px solid var(--sl-color-gray-5);
        border-radius: 0.5rem;
        padding: 0.5rem;
        min-width: 180px;
        display: none;
        flex-direction: column;
        gap: 0.25rem;
        box-shadow: var(--sl-shadow-md);
        z-index: 1000;
        margin-top: 0.5rem;
    }

    .dropdown.open .dropdown-content {
        display: flex;
    }

    .dropdown-content li {
        width: 100%;
    }

    .dropdown-content a {
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        display: block;
        width: 100%;
    }

    .dropdown-content a:hover {
        background-color: var(--sl-color-gray-6);
        color: var(--sl-color-white);
    }

    .search-wrapper {
        display: flex;
        justify-content: flex-end;
        margin: 0 1rem;
    }

    /* Desktop: Expand search bar only on very large screens */
    @media (min-width: 72rem) {
        .search-wrapper {
            flex-grow: 1;
            justify-content: center;
            width: auto; /* Allow flex-grow to handle width, preventing overflow */
            max-width: 100%;
        }

        /* Force search button to take available space */
        .search-wrapper :global(site-search),
        .search-wrapper :global(.site-search) {
            width: 100%;
            max-width: 100%;
        }

        .search-wrapper :global(button[data-open-modal]) {
            width: 100% !important;
            border: 1px solid var(--sl-color-gray-5);
            border-radius: 0.5rem;
            padding-inline: 1rem;
            justify-content: space-between;
        }
    }

    /* Medium screens: Give search bar reasonable space */
    /* Medium screens: Give search bar reasonable space and force full display */
    @media (min-width: 50rem) and (max-width: 71.9375rem) {
        .search-wrapper {
            flex-grow: 1;
            min-width: 200px;
            max-width: 400px;
            margin-inline: 1rem; /* Match the 1rem gap of right-group */
        }

        /* Force search button to look like desktop version */
        .search-wrapper :global(site-search),
        .search-wrapper :global(.site-search) {
            width: 100%;
            max-width: 100%;
        }

        .search-wrapper :global(button[data-open-modal]) {
            width: 100% !important;
            border: 1px solid var(--sl-color-gray-5);
            border-radius: 0.5rem;
            padding-inline: 1rem;
            justify-content: space-between;
            background-color: var(--sl-color-black);
        }

        /* Force visibility of text and shortcut hint inside the button */
        .search-wrapper :global(button[data-open-modal] > *),
        .search-wrapper :global(button[data-open-modal] .sl-hidden),
        .search-wrapper :global(button[data-open-modal] .sl-hidden-md) {
            display: flex !important;
        }
    }

    .right-group {
        gap: 1rem;
        align-items: center;
    }

    .social-icons a {
        color: var(--sl-color-text-accent);
    }

    .social-icons a:hover {
        color: var(--sl-color-white);
    }

    /* Mobile Drawer Styles */
    .mobile-drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition:
            opacity 0.3s ease,
            visibility 0.3s ease;
    }

    .mobile-drawer-overlay.open {
        opacity: 1;
        visibility: visible;
    }

    .mobile-drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--sl-color-gray-5);
    }

    .mobile-drawer-title {
        font-size: var(--sl-text-lg);
        font-weight: 600;
        color: var(--sl-color-white);
    }

    .mobile-drawer-close {
        background: none;
        border: none;
        color: var(--sl-color-gray-3);
        cursor: pointer;
        padding: 0.5rem;
    }

    .mobile-drawer-close:hover {
        color: var(--sl-color-white);
    }

    /* Social links and theme selector row */
    .mobile-drawer-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--sl-color-gray-5);
    }

    .mobile-drawer-social {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .mobile-drawer-social a {
        color: var(--sl-color-gray-3);
        transition: color 0.2s ease;
        display: flex;
        align-items: center;
    }

    .mobile-drawer-social a:hover {
        color: var(--sl-color-white);
    }

    .mobile-drawer-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .mobile-drawer-nav a,
    .mobile-dropdown-btn {
        display: block;
        padding: 1rem;
        color: var(--sl-color-text); /* Use theme text color */
        text-decoration: none;
        border-bottom: 1px solid var(--sl-color-gray-5);
        font-size: var(--sl-text-base);
        width: 100%;
        text-align: left;
        background: none;
        border: none;
        cursor: pointer;
    }

    .mobile-drawer-nav a:hover,
    .mobile-dropdown-btn:hover {
        background-color: var(--sl-color-gray-6);
        color: var(--sl-color-white);
    }

    /* Mobile Dropdown */
    .mobile-dropdown-content {
        display: none;
        background-color: var(--sl-color-bg-sidebar);
        padding-left: 1rem;
    }

    .mobile-dropdown.open .mobile-dropdown-content {
        display: block;
    }

    .mobile-caret {
        margin-left: 0.5rem;
        transition: transform 0.2s ease;
    }

    .mobile-dropdown.open .mobile-caret {
        transform: rotate(180deg);
    }

    .mobile-menu-btn {
        display: block; /* Show by default */
        background: none;
        border: none;
        color: var(--sl-color-white);
        cursor: pointer;
        padding: 0.5rem;
    }

    /* Hide the three-dot menu on large screens where nav links are visible */
    @media (min-width: 72rem) {
        .mobile-menu-btn {
            display: none;
        }
    }

    /* Explicitly show the three-dot menu on medium screens when TOC is compact */
    @media (min-width: 50rem) and (max-width: 71.9375rem) {
        .mobile-menu-btn {
            display: block !important;
            margin-right: 1rem; /* Add spacing before search bar */
        }
    }

    /* Mobile Layout Fixes */

    /* 1. Reserve space for Starlight's hamburger menu and ensure flexible layout */
    @media (max-width: 71.9375rem) {
        .custom-header-container {
            padding-right: 1.5rem !important; /* Reduced reserved space for Starlight hamburger */
            gap: 0 !important; /* Remove gap between groups to tighten spacing */
        }

        /* Ensure left group takes available space */
        .left-group {
            flex: 1;
            max-width: 100%;
            min-width: 0; /* Allow shrinking */
            align-items: center;
            gap: 0.5rem !important; /* Reduce gap on mobile */
        }

        /* Allow title to shrink if needed but GROW to fill space */
        .title-wrapper {
            flex: 1 1 auto !important; /* Grow to fill space, shrink if needed */
            min-width: 0;
            overflow: hidden;
            margin-right: 0; /* Remove margin to bring dots closer */
        }

        /* Prevent logo from shrinking */
        .brand-logo,
        .brand-logo img {
            flex-shrink: 0 !important;
        }

        /* Force truncation on the title text elements */
        .title-wrapper :global(a),
        .title-wrapper :global(span),
        .site-title {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        /* Show mobile menu button on mobile and medium screens */
        .mobile-menu-btn {
            flex: 0 0 auto;
            margin-right: 0.25rem; /* Small gap between dots and search */
            display: block !important; /* Force show with !important */
        }
    }

    /* 2. Ensure search icon is ALWAYS visible on mobile and medium screens */
    @media (max-width: 71.9375rem) {
        .search-wrapper {
            display: flex !important;
            flex: 0 0 auto !important;
            width: auto !important;
            height: auto !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            pointer-events: auto !important;
        }

        .search-wrapper button {
            display: flex !important;
            width: auto !important;
            height: auto !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            padding-inline: 0.5rem !important; /* Reduce internal padding of search button if needed */
        }

        .search-wrapper :global(.sl-hidden) {
            display: none !important;
        }
    }

    /* 3. Mobile-specific search bar adjustments */
    @media (max-width: 49.9375rem) {
        .search-wrapper {
            margin: 0 !important;
        }
    }

    /* Mobile Drawer Styles */
    .mobile-drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition:
            opacity 0.3s ease,
            visibility 0.3s ease;
    }

    .mobile-drawer-overlay.open {
        opacity: 1;
        visibility: visible;
    }

    .mobile-drawer {
        position: fixed;
        top: 0;
        left: 0;
        width: 80%;
        max-width: 350px;
        height: 100vh !important;
        background-color: var(--sl-color-bg-nav);
        z-index: 9999;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        box-shadow: var(--sl-shadow-xl);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }

    .mobile-drawer.open {
        transform: translateX(0);
    }

    .mobile-drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--sl-color-gray-5);
    }

    .mobile-drawer-title {
        font-size: var(--sl-text-lg);
        font-weight: 600;
        color: var(--sl-color-white);
    }

    .mobile-drawer-close {
        background: none;
        border: none;
        color: var(--sl-color-gray-3);
        cursor: pointer;
        padding: 0.5rem;
    }

    .mobile-drawer-close:hover {
        color: var(--sl-color-white);
    }

    .mobile-drawer-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .mobile-drawer-nav a,
    .mobile-dropdown-btn {
        display: block;
        padding: 1rem;
        color: var(--sl-color-text); /* Use theme text color */
        text-decoration: none;
        border-bottom: 1px solid var(--sl-color-gray-5);
        font-size: var(--sl-text-base);
        width: 100%;
        text-align: left;
        background: none;
        border: none;
        cursor: pointer;
    }

    .mobile-drawer-nav a:hover,
    .mobile-dropdown-btn:hover {
        background-color: var(--sl-color-gray-6);
        color: var(--sl-color-white);
    }

    .mobile-dropdown-content a {
        padding-left: 1rem;
        font-size: var(--sl-text-sm);
        border-bottom: none; /* Optional: remove border for cleaner look inside dropdown */
    }

    /* Mobile Dropdown */
    .mobile-drawer-nav .mobile-dropdown-content {
        display: none;
        background-color: transparent;
        padding-left: 0;
        margin-left: 1rem !important;
        border-left: 1px solid var(--sl-color-gray-5);
    }

    .mobile-dropdown.open .mobile-dropdown-content {
        display: block;
    }

    .mobile-caret {
        margin-left: 0.5rem;
        transition: transform 0.2s ease;
    }

    .mobile-dropdown.open .mobile-caret {
        transform: rotate(180deg);
    }

    .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        color: var(--sl-color-white);
        cursor: pointer;
        padding: 0.5rem;
    }

    /* Mobile Layout Fixes */

    /* 1. Reserve space for Starlight's hamburger menu and ensure flexible layout */
    @media (max-width: 49.9375rem) {
        .custom-header-container {
            padding-right: 1.5rem !important; /* Reduced reserved space for Starlight hamburger */
            gap: 0 !important; /* Remove gap between groups to tighten spacing */
        }

        /* Ensure left group takes available space */
        .left-group {
            flex: 1;
            max-width: 100%;
            min-width: 0; /* Allow shrinking */
            align-items: center;
            gap: 0.5rem !important; /* Reduce gap on mobile */
        }

        /* Allow title to shrink if needed but GROW to fill space */
        .title-wrapper {
            flex: 1 1 auto !important; /* Grow to fill space, shrink if needed */
            min-width: 0;
            overflow: hidden;
            margin-right: 0; /* Remove margin to bring dots closer */
        }

        /* Prevent logo from shrinking */
        .brand-logo,
        .brand-logo img {
            flex-shrink: 0 !important;
        }

        /* Force truncation on the title text elements */
        .title-wrapper :global(a),
        .title-wrapper :global(span),
        .site-title {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        /* Prevent mobile menu button from shrinking */
        .mobile-menu-btn {
            flex: 0 0 auto;
            margin-right: 0.25rem; /* Small gap between dots and search */
            display: block; /* Show on mobile */
        }
    }

    /* 2. Ensure search icon is ALWAYS visible on mobile */
    @media (max-width: 49.9375rem) {
        .search-wrapper {
            display: flex !important;
            flex: 0 0 auto !important;
            width: auto !important;
            height: auto !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            margin: 0 !important; /* Remove margin to bring search closer to dots and edge */
        }

        .search-wrapper button {
            display: flex !important;
            width: auto !important;
            height: auto !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            padding-inline: 0.5rem !important; /* Reduce internal padding of search button if needed */
        }

        .search-wrapper :global(.sl-hidden) {
            display: none !important;
        }
    }

    /* 3. Ultra-narrow screens (< 400px): Two-row layout */
    @media (max-width: 25rem) {
        :global(:root) {
            --sl-nav-height: 5rem !important; /* Reduced from 6rem */
        }

        .custom-header-container {
            flex-wrap: wrap !important;
            height: auto !important;
            min-height: var(--sl-nav-height);
            min-height: var(--sl-nav-height);
            padding-bottom: 0.5rem !important;
            padding-left: 1rem !important; /* Symmetric padding */
            padding-left: 1rem !important; /* Symmetric padding */
            padding-right: 1rem !important; /* Symmetric padding */
            align-content: center !important;
            justify-content: flex-start !important; /* Left align everything */
            /* Removed background-color to restore theme default */
        }

        .left-group {
            display: contents !important; /* Flatten structure */
        }

        .title-wrapper {
            flex: 1 0 100% !important; /* Force full width */
            margin-bottom: 0 !important; /* Removed margin between rows */
            margin-right: 0 !important;
            justify-content: flex-start !important; /* Left align title */
        }

        .mobile-menu-btn {
            order: 2;
            margin-left: -0.5rem !important; /* Compensate for padding to align with logo */
            padding-left: 0.5rem !important; /* Match logo offset for vertical alignment */
            margin-right: 0.5rem !important; /* Small gap before search icon */
            /* Ensure vertical center */
            align-self: center !important;
            height: auto !important;
            display: flex;
            align-items: center;
        }

        .search-wrapper {
            order: 3;
            margin: 0 !important;
            margin-bottom: 0.5rem !important; /* Push up from bottom */
            justify-content: flex-start !important; /* Align content to left */
            flex: 0 1 auto !important;
            /* Fix vertical alignment */
            align-self: center !important;
            display: flex !important;
            align-items: center !important;
            height: auto !important;
        }

        /* Ensure search button doesn't take full width if it was set to */
        .search-wrapper button {
            width: auto !important;
            margin: 0 !important;
            padding: 0.5rem !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
            height: auto !important;
        }
    }
</style>
